name: build

on:
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW32
          update: true
          install: >-
            git
            base-devel
            mingw-w64-i686-toolchain
            mingw-w64-i686-cmake
            mingw-w64-i686-libtool
            mingw-w64-i686-openssl
            mingw-w64-i686-pkg-config
            autoconf
            automake
            automake-wrapper
            make
            zip

      - name: Build full static chain
        shell: msys2 {0}
        run: |
          export CFLAGS="-O2 -static"
          export CXXFLAGS="-O2 -static"
          export LDFLAGS="-static -static-libgcc -static-libstdc++"

          repos="libplist libimobiledevice-glue libusbmuxd"

          for repo in $repos; do
            echo "=== Building $repo ==="
            git clone https://github.com/libimobiledevice/$repo.git
            cd $repo

            ./autogen.sh \
              --host=i686-w64-mingw32 \
              --prefix=/mingw32 \
              --enable-static \
              --disable-shared \
              --disable-dependency-tracking

            make -j$(nproc)
            make install

            cd ..
            rm -rf $repo
          done

          git clone https://github.com/libimobiledevice/libusbmuxd.git libusbmuxd-final
          cd libusbmuxd-final
          ./autogen.sh \
            --host=i686-w64-mingw32 \
            --prefix=/mingw32 \
            --enable-static \
            --disable-shared
          make -j$(nproc)

      - name: Package only the .lib we need
        shell: msys2 {0}
        run: |
          mkdir rel
          cp libusbmuxd-final/src/.libs/libusbmuxd-2.0.a rel/libusbmuxd-2.0.lib
          cp /mingw32/lib/libplist-2.0.a rel/ || true
          zip -j libusbmuxd-static-w32.zip rel/*

      - name: Upload
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="static-$(date +%Y%m%d-%H%M)"
          gh release create "$TAG" --title "$TAG" --generate-notes
          gh release upload "$TAG" libusbmuxd-static-w32.zip --clobber
