name: build-native-aot-compatible
on:
  schedule:
      - cron: '0 0 * * 0'
  workflow_dispatch:
permissions:
  contents: write 
jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up MSYS2 with CLANG64
        uses: msys2/setup-msys2@v2
        with:
          msystem: CLANG64
          install: >
            git
            mingw-w64-clang-x86_64-clang
            mingw-w64-clang-x86_64-lld
            mingw-w64-clang-x86_64-openssl
            mingw-w64-clang-x86_64-curl
            libtool
            autoconf
            automake
            make
            pkgconf
            zip
          update: true
      
      - name: Build Static Libraries
        shell: msys2 {0}
        run: |
          export LDFLAGS="-static"
          export CFLAGS="-O2 -DLIBPLIST_STATIC -DLIBIMOBILEDEVICE_STATIC -DLIBUSBMUXD_STATIC"
          export CPPFLAGS="-DLIBPLIST_STATIC -DLIBIMOBILEDEVICE_STATIC -DLIBUSBMUXD_STATIC"
          
          repos=("libplist" "libimobiledevice-glue" "libusbmuxd" "libtatsu" "libimobiledevice")
          for repo in "${repos[@]}"; do
            echo "Building $repo..."
            git clone "https://github.com/libimobiledevice/$repo"
            pushd "$repo" > /dev/null
            
            ./autogen.sh --prefix=/clang64 \
                         --enable-static \
                         --disable-shared \
                         CFLAGS="$CFLAGS" \
                         CPPFLAGS="$CPPFLAGS" \
                         LDFLAGS="$LDFLAGS"
            
            make -j$(nproc) CFLAGS="$CFLAGS" CPPFLAGS="$CPPFLAGS" || true
            make install || true
            popd > /dev/null
          done
      
      - name: Collect static libraries
        shell: msys2 {0}
        run: |
          mkdir -p release/lib
          mkdir -p release/include
          
          find /clang64/lib -name "*.a" -type f | while read f; do
            cp "$f" release/lib/ || true
          done
          
          cp -r /clang64/include/libimobiledevice* release/include/ || true
          cp -r /clang64/include/plist release/include/ || true
          cp -r /clang64/include/libusbmuxd release/include/ || true
          
          cd release/lib
          for f in *.a; do
            if [ -f "$f" ]; then
              mv "$f" "${f%.a}.lib"
            fi
          done
          
          ls -lh
      
      - name: Create usage example
        shell: bash
        run: |
          cat > release/README.md << 'ENDOFFILE'
          # libimobiledevice for .NET Native AOT
          
          ## Important Notes
          
          These are static libraries built with CLANG64 for Windows.
          
          ## Usage in C# Project
          
          Add to your .csproj:
          
          <ItemGroup>
            <NativeLibrary Include="lib\libimobiledevice-1.0.lib" />
            <NativeLibrary Include="lib\libplist-2.0.lib" />
            <NativeLibrary Include="lib\libusbmuxd-2.0.lib" />
            <NativeLibrary Include="lib\libtatsu-1.0.lib" />
            <NativeLibrary Include="lib\libimobiledevice-glue-1.0.lib" />
            <DirectPInvoke Include="ws2_32" />
            <DirectPInvoke Include="crypt32" />
          </ItemGroup>
          
          ## Define These Before Including
          
          When using P/Invoke, define:
          - LIBPLIST_STATIC
          - LIBIMOBILEDEVICE_STATIC
          - LIBUSBMUXD_STATIC
          ENDOFFILE
      
      - name: Package Release
        shell: bash
        run: |
          cd release
          zip -r ../libimobiledevice-native-aot-win-x64.zip .
      
      - name: Publish Release
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
        run: |
          TAG="v$(date +'%Y%m%d')-$(git rev-parse --short HEAD)"
          echo "TAG=$TAG" >> $GITHUB_ENV
          gh release create "$TAG" --title "Release - .NET Native AOT Static Libraries" || true
          gh release upload "$TAG" libimobiledevice-native-aot-win-x64.zip
        shell: bash
